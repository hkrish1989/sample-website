<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Market Dashboard</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial;
    background: #f4f6f8;
    text-align: center;
    padding: 30px;
}
.card {
    background: white;
    padding: 20px;
    width: 420px;
    margin: auto;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
select {
    padding: 8px;
    margin-bottom: 15px;
}
.up { color: green; }
.down { color: red; }
canvas {
    margin-top: 20px;
}
</style>
</head>

<body>

<div class="card">
    <h2>ðŸ“Š Market Trend Dashboard</h2>

    <!-- DROPDOWN -->
    <select id="symbol" onchange="loadData()">
        <option value="TCS.NSE">TCS</option>
        <option value="RELIANCE.BSE">Reliance</option>
        <option value="INFY.NSE">Infosys</option>
        <option value="^NSEI">NIFTY 50</option>
        <option value="^BSESN">SENSEX</option>
    </select>

    <p><b>Today Close:</b> â‚¹<span id="today"></span></p>
    <p><b>Yesterday Close:</b> â‚¹<span id="yesterday"></span></p>
    <p><b>Change:</b> <span id="change"></span></p>
    <h3 id="trend"></h3>

    <canvas id="chart" height="200"></canvas>
</div>

<script>
const API_KEY = "MPD608D4EMSJLXQ5";
let chart;

/* AUTO REFRESH ONCE DAILY */
const lastFetch = localStorage.getItem("lastFetch");
const todayDate = new Date().toDateString();

if (lastFetch !== todayDate) {
    localStorage.setItem("lastFetch", todayDate);
    loadData();
} else {
    loadData();
}

function loadData() {
    const symbol = document.getElementById("symbol").value;
    const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${API_KEY}`;

    fetch(url)
    .then(res => res.json())
    .then(data => {
        const series = data["Time Series (Daily)"];
        const dates = Object.keys(series).slice(0, 7).reverse();

        const prices = dates.map(d => parseFloat(series[d]["4. close"]));

        const today = prices[prices.length - 1];
        const yesterday = prices[prices.length - 2];

        const diff = today - yesterday;
        const percent = ((diff / yesterday) * 100).toFixed(2);

        document.getElementById("today").innerText = today.toFixed(2);
        document.getElementById("yesterday").innerText = yesterday.toFixed(2);
        document.getElementById("change").innerText =
            `${diff.toFixed(2)} (${percent}%)`;

        const trendEl = document.getElementById("trend");
        if (diff > 0) {
            trendEl.innerText = "UP TREND ðŸ“ˆ";
            trendEl.className = "up";
        } else {
            trendEl.innerText = "DOWN TREND ðŸ“‰";
            trendEl.className = "down";
        }

        drawChart(dates, prices);
    })
    .catch(err => alert("API limit reached or error"));
}

function drawChart(labels, data) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Closing Price",
                data: data,
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}
</script>

</body>
</html>
